# images-srv
Images tools microservice.

## Настройки.

```
# .env
DAEMON=yes	# run as daemon
PORT=3333	# tcp/ip port binding

BACK_HOST=http://localhost:3000	# URL бэкенда с аутентификацией

PUBLIC_DIR=/var/www/public	# корневая общедоступная папка
IMAGES_SUB=/images		# подпапка для картинок

IMAGES_SIZES="500x400,400x300"	# размеры нарезанных картинок
```
```
# config/app.rb
set :resources, [ 'models', 'vehicles' ]	# ресурсы для которых будут храниться картинки
```

## Список картинок.

#### Вывести список всех картинок сущности resource/id с их размерами в JSON формате:
Обязательный HTTP-заголовок Accept: application/json или X-Requested-With: XMLHttpRequest (многие JS-фреймворки проставляют его сами), иначе вернет html-страничку.
**GET запрос:**
```
http://<hostname>/images/<resource>/<id>
```

#### Вывести список всех картинок в хранилище с их размерами в JSON формате:
**GET запрос:**
```
http://<hostname>/images
```

## Загрузка картинок.
**POST запрос:**
```
http://<hostname>/images/<resource>/<id>
```
**Параметры (body):**
```
file: <file> - загружаемый файл.
offsets: "+100+100-100-100" - строка в формате "+x+y-x-y", где 'x' и 'y' - размеры отрезов в пикселях
	по горизонтали и вертикали (передаются только парами), '+' - означает отрезать слева/сверху,
	'-' - справа/снизу.
```
Пар может быть сколько угодно или вообще не быть (чтоб обрезать со всех 4х сторон достаточно 2х пар).

#### Так же есть простенькая форма для тестов в браузере, доступная через GET запрос:
```
http://<hostname>/images/<resource>/<id>
```

## Удаление картинок.
**DELETE запрос:**
```
http://<hostname>/images/<resource>/<id>
```
Удалит все кратинки сущности **resource**/**id**.

**DELETE запрос:**
```
http://<hostname>/images/<resource>/<id>/<filename>
```
Удалит картинку сущности **resource**/**id** с именем файла **filename** со всеми размерами.

## Аутентификация/авторизация.

Аутентификация предполагает использования механизма **gem tiddle** на бэкенде, где от клиента передаются данные аутентификации в заголовке в полях X-USER-EMAIL и X-USER-TOKEN, которые проверяются сервисом на бэкенде спомощью GET-запроса /auth/check_in, который возвращает объект user, которому эти данные принаджелат.
Для авторизации проверяется поле role в объекте user, которое должно соответствовать "admin" для доступа к сервису.
